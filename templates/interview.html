<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üéØ AI Interview System</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: #ffffff;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      background: rgba(0, 0, 0, 0.5);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
      text-align: center;
      border: 2px solid #00d4ff;
    }
    
    h1 {
      color: #00d4ff;
      font-size: 2em;
      margin-bottom: 10px;
    }
    
    .main-grid {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .video-section {
      background: rgba(0, 0, 0, 0.6);
      padding: 20px;
      border-radius: 10px;
      border: 2px solid #00d4ff;
    }
    
    video {
      width: 100%;
      border-radius: 10px;
      background: #000;
    }
    
    .video-status {
      margin-top: 15px;
      padding: 15px;
      background: rgba(0, 212, 255, 0.1);
      border-radius: 5px;
      font-size: 0.9em;
    }
    
    .question-section {
      background: rgba(0, 0, 0, 0.6);
      padding: 30px;
      border-radius: 10px;
      border: 2px solid #00d4ff;
    }
    
    .question-text {
      font-size: 1.5em;
      margin-bottom: 20px;
      color: #00d4ff;
      font-weight: 600;
    }
    
    .question-tip {
      background: rgba(255, 193, 7, 0.2);
      padding: 15px;
      border-radius: 5px;
      border-left: 4px solid #ffc107;
      margin-bottom: 20px;
      font-size: 0.9em;
    }
    
    .metrics {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-top: 20px;
    }
    
    .metric-card {
      background: rgba(0, 212, 255, 0.1);
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      border: 1px solid rgba(0, 212, 255, 0.3);
    }
    
    .metric-value {
      font-size: 2em;
      font-weight: bold;
      color: #00d4ff;
    }
    
    .metric-label {
      font-size: 0.9em;
      color: #aaa;
      margin-top: 5px;
    }
    
    .btn {
      padding: 15px 30px;
      border: none;
      border-radius: 5px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin: 10px;
    }
    
    .btn-primary {
      background: #00d4ff;
      color: #000;
    }
    
    .btn-primary:hover {
      background: #00b8e6;
      transform: scale(1.05);
    }
    
    .btn-danger {
      background: #ff4444;
      color: #fff;
    }
    
    .btn-success {
      background: #28a745;
      color: #fff;
    }
    
    .recording-controls {
      text-align: center;
      margin-top: 30px;
    }
    
    .timer {
      font-size: 3em;
      color: #00d4ff;
      margin: 20px 0;
      font-weight: bold;
    }
    
    .violations-panel {
      background: rgba(255, 68, 68, 0.2);
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
      border: 2px solid #ff4444;
      display: none;
    }
    
    .violations-panel.active {
      display: block;
    }
    
    .violation-item {
      padding: 10px;
      margin: 10px 0;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 5px;
      border-left: 4px solid #ff4444;
    }
    
    .progress-bar {
      width: 100%;
      height: 30px;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 15px;
      overflow: hidden;
      margin: 20px 0;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #00d4ff, #00ffc8);
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #000;
    }
    
    .hidden { display: none !important; }
    
    .status-good { color: #28a745; }
    .status-warning { color: #ffc107; }
    .status-error { color: #ff4444; }
  </style>
</head>
<body>
  <div id="app-data" 
       data-questions='{{ questions | tojson }}'
       data-session-id="{{ session_id }}"
       style="display: none;">
  </div>
  
  <div class="container">
    <header>
      <h1>üéØ AI-Powered Interview Assessment</h1>
      <p>Session ID: <span id="sessionId">{{ session_id }}</span></p>
      <p>Real-time integrity monitoring active</p>
    </header>
    
    <div class="main-grid">
      <div class="video-section">
        <video id="webcam" autoplay playsinline></video>
        <div class="video-status">
          <div>üìπ Camera: <span id="cameraStatus" class="status-good">Active</span></div>
          <div>üë§ Face: <span id="faceStatus">Detecting...</span></div>
          <div>üí° Lighting: <span id="lightingStatus">Checking...</span></div>
        </div>
      </div>
      
      <div class="question-section">
        <div id="questionArea">
          <h2>Question <span id="questionNumber">1</span> of {{ questions|length }}</h2>
          <div class="question-text" id="questionText">Loading question...</div>
          <div class="question-tip" id="questionTip">üí° Tip: Speak clearly and confidently</div>
          
          <div class="timer" id="timer">60</div>
          
          <div class="recording-controls">
            <button class="btn btn-primary" id="startBtn" onclick="startAnswer()">üé§ Start Recording</button>
            <button class="btn btn-success hidden" id="submitBtn" onclick="submitAnswer()">‚úÖ Submit Answer</button>
          </div>
        </div>
        
        <div id="completionArea" class="hidden">
          <h2>‚úÖ Interview Complete!</h2>
          <p>Processing your responses...</p>
          <button class="btn btn-primary" onclick="viewResults()">üìä View Results</button>
        </div>
        
        <div id="terminationArea" class="hidden">
          <h2>‚ùå Interview Terminated</h2>
          <p id="terminationReason"></p>
          <button class="btn btn-primary" onclick="viewResults()">üìä View Partial Results</button>
        </div>
      </div>
    </div>
    
    <div class="metrics">
      <div class="metric-card">
        <div class="metric-value" id="integrityScore">100</div>
        <div class="metric-label">Integrity Score</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="violationCount">0</div>
        <div class="metric-label">Violations</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="questionProgress">0</div>
        <div class="metric-label">Questions Answered</div>
      </div>
    </div>
    
    <div class="violations-panel" id="violationsPanel">
      <h3>‚ö†Ô∏è Violations Detected</h3>
      <div id="violationsList"></div>
    </div>
    
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
    </div>
  </div>

  <script>
    var QUESTIONS = JSON.parse(document.getElementById('app-data').dataset.questions);
    var SESSION_ID = document.getElementById('app-data').dataset.sessionId;
    var CAPTURE_INTERVAL = 3000; // Capture every 3 seconds
    var VIOLATION_THRESHOLD = 3;
    
    var currentQuestion = 0;
    let isRecording = false;
    var originalInterfaceHTML = '';
    let mediaRecorder = null;
    let recordedChunks = [];
    let recordingStartTime = 0;
    let timerInterval = null;
    let captureInterval = null;
    let webcamStream = null;
    let isSetupComplete = false;
    let setupFramesGood = 0;
    var isTabFocused = true;
    
    var sessionData = {
      violations: [],
      integrityScore: 100,
      status: 'setup',
      blinkCount: 0,
      tabSwitches: 0
    };
    
    // Tab/Window focus detection
    document.addEventListener('visibilitychange', function() {
      if (document.hidden && sessionData.status === 'active' && isRecording) {
        isTabFocused = false;
        logTabSwitch();
      } else {
        isTabFocused = true;
      }
    });
    
    window.addEventListener('blur', function() {
      if (sessionData.status === 'active' && isRecording) {
        isTabFocused = false;
        logTabSwitch();
      }
    });
    
    window.addEventListener('focus', function() {
      isTabFocused = true;
    });
    
    function logTabSwitch() {
      sessionData.tabSwitches++;
      
      fetch('/log_tab_switch', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      })
      .then(res => res.json())
      .then(data => {
        console.log('Tab switch logged:', data);
        addViolationToUI({
          type: 'tab_switch',
          severity: 'high',
          message: 'Tab/window switched (Total: ' + data.tab_switches + ')'
        });
        sessionData.integrityScore = data.integrity_score;
        document.getElementById('integrityScore').textContent = data.integrity_score;
        document.getElementById('violationCount').textContent = sessionData.violations.length + 1;
      });
    }
    
    async function init() {
      originalInterfaceHTML = document.getElementById('questionArea').innerHTML;
      try {
        // Request camera access
        webcamStream = await navigator.mediaDevices.getUserMedia({ 
          video: { width: 640, height: 480 }, 
          audio: true 
        });
        
        const videoElement = document.getElementById('webcam');
        videoElement.srcObject = webcamStream;
        
        document.getElementById('cameraStatus').textContent = 'Active';
        document.getElementById('cameraStatus').className = 'status-good';
        
        // Wait for video to be ready
        videoElement.addEventListener('loadeddata', () => {
          startSetupPhase();
        });
        
      } catch (err) {
        console.error('Camera access error:', err);
        document.getElementById('cameraStatus').textContent = 'Failed';
        document.getElementById('cameraStatus').className = 'status-error';
        alert('‚ùå Camera access denied. Please enable camera to continue.');
      }
    }
    
    function startSetupPhase() {
      sessionData.status = 'setup';
      
      document.getElementById('questionArea').innerHTML = '<h2>üì∏ Camera Position Setup</h2>' +
        '<div class="question-tip"><strong>Please adjust your position:</strong>' +
        '<ul style="text-align: left; margin-top: 15px;">' +
        '<li>‚úÖ Sit centered in the frame</li>' +
        '<li>‚úÖ Ensure your face is clearly visible</li>' +
        '<li>‚úÖ Good lighting on your face</li>' +
        '<li>‚úÖ Remove any unauthorized items from view</li>' +
        '<li>‚úÖ Ensure you are the only person visible</li></ul></div>' +
        '<div style="margin-top: 30px;">' +
        '<h3>Position Status: <span id="setupStatus" class="status-warning">Adjusting...</span></h3>' +
        '<div class="progress-bar"><div class="progress-fill" id="setupProgress" style="width: 0%">0%</div></div>' +
        '<p style="margin-top: 15px; color: #aaa;">Hold a good position for 5 seconds to continue</p></div>';
      
      setupFramesGood = 0;
      const REQUIRED_GOOD_FRAMES = 5;
      
      const setupInterval = setInterval(function() {
        captureAndSendFrame(function(data) {
          const isGoodFrame = data.status !== 'terminated' && 
                             !data.should_terminate && 
                             data.violations.length === 0 &&
                             data.warnings.length === 0;
          
          if (isGoodFrame) {
            setupFramesGood++;
            const progress = (setupFramesGood / REQUIRED_GOOD_FRAMES) * 100;
            document.getElementById('setupProgress').style.width = progress + '%';
            document.getElementById('setupProgress').textContent = Math.round(progress) + '%';
            
            if (setupFramesGood >= REQUIRED_GOOD_FRAMES) {
              clearInterval(setupInterval);
              completeSetup();
            } else {
              document.getElementById('setupStatus').textContent = 'Good! Hold position...';
              document.getElementById('setupStatus').className = 'status-good';
            }
          } else {
            setupFramesGood = Math.max(0, setupFramesGood - 1);
            document.getElementById('setupStatus').textContent = 'Adjust position';
            document.getElementById('setupStatus').className = 'status-warning';
            
            if (data.violations.length > 0) {
              document.getElementById('setupStatus').textContent = data.violations[0].message;
              document.getElementById('setupStatus').className = 'status-error';
            } else if (data.warnings.length > 0) {
              document.getElementById('setupStatus').textContent = data.warnings[0].message;
            }
          }
        });
      }, 2000);
    }
    
    function completeSetup() {
      fetch('/setup_complete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      })
      .then(res => res.json())
      .then(data => {
        isSetupComplete = true;
        sessionData.status = 'active';
        
        document.getElementById('questionArea').innerHTML = '<h2>‚úÖ Setup Complete!</h2>' +
          '<div class="question-tip" style="background: rgba(40, 167, 69, 0.2); border-color: #28a745;">' +
          '<p style="font-size: 1.2em; margin-bottom: 15px;">Your position is perfect. The interview will begin in 3 seconds...</p></div>';
        
        setTimeout(function() {
          document.getElementById('questionArea').innerHTML = originalInterfaceHTML;
          loadQuestion(0);
          startContinuousCapture();
        }, 3000);
      });
    }
    
    function captureAndSendFrame(callback) {
      const video = document.getElementById('webcam');
      const canvas = document.createElement('canvas');
      canvas.width = 640;
      canvas.height = 480;
      const context = canvas.getContext('2d');
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      const imageData = canvas.toDataURL('image/jpeg', 0.7);
      
      fetch('/capture', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ image: imageData })
      })
      .then(res => {
        if (!res.ok) throw new Error('Server busy');
        return res.json();
      })
      .then(data => {
        if (callback) callback(data);
        else handleFrameAnalysis(data);
      })
      .catch(err => {
        console.warn('Frame capture error:', err);
      });
    }
    
    function startContinuousCapture() {
      const captureLoop = function() {
        if (sessionData.status !== 'active') return;
        
        captureAndSendFrame();
        
        setTimeout(captureLoop, CAPTURE_INTERVAL);
      };
      
      captureLoop();
    }
    
    function handleFrameAnalysis(data) {
      sessionData.integrityScore = data.integrity_score;
      document.getElementById('integrityScore').textContent = data.integrity_score;
      
      if (data.blink_detected) {
        sessionData.blinkCount++;
      }
      
      if (data.violations && data.violations.length > 0) {
        data.violations.forEach(function(violation) {
          sessionData.violations.push(violation);
          addViolationToUI(violation);
        });
        
        document.getElementById('violationCount').textContent = sessionData.violations.length;
        document.getElementById('violationsPanel').classList.add('active');
      }
      
      if (data.warnings && data.warnings.length > 0) {
        data.warnings.forEach(function(warning) {
          if (warning.type === 'no_face') {
            document.getElementById('faceStatus').textContent = '‚ùå No Face';
            document.getElementById('faceStatus').className = 'status-error';
          } else if (warning.type === 'lighting') {
            document.getElementById('lightingStatus').textContent = '‚ö†Ô∏è ' + warning.message;
            document.getElementById('lightingStatus').className = 'status-warning';
          } else if (warning.type === 'looking_away') {
            document.getElementById('faceStatus').textContent = '‚ö†Ô∏è Looking Away';
            document.getElementById('faceStatus').className = 'status-warning';
          }
        });
      } else {
        document.getElementById('faceStatus').textContent = '‚úÖ Detected';
        document.getElementById('faceStatus').className = 'status-good';
        document.getElementById('lightingStatus').textContent = '‚úÖ Good';
        document.getElementById('lightingStatus').className = 'status-good';
      }
      
      if (data.eye_contact) {
        document.getElementById('faceStatus').textContent = '‚úÖ Eye Contact';
        document.getElementById('faceStatus').className = 'status-good';
      }
      
      if (data.should_terminate) {
        terminateInterview(data.reason);
      }
    }
    
    function addViolationToUI(violation) {
      const violationsList = document.getElementById('violationsList');
      const div = document.createElement('div');
      div.className = 'violation-item';
      div.innerHTML = '<strong>' + violation.severity.toUpperCase() + '</strong>: ' + violation.message +
        '<br><small>Question ' + (currentQuestion + 1) + ' - ' + new Date().toLocaleTimeString() + '</small>';
      violationsList.appendChild(div);
    }
    
    function loadQuestion(index) {
      if (index >= QUESTIONS.length) {
        completeInterview();
        return;
      }
      
      const question = QUESTIONS[index];
      currentQuestion = index;
      
      document.getElementById('questionNumber').textContent = index + 1;
      document.getElementById('questionText').textContent = question.question;
      document.getElementById('questionTip').innerHTML = 'üí° Tip: ' + question.tip;
      document.getElementById('timer').textContent = question.duration;
      
      updateProgress();
    }
    
    function updateProgress() {
      const progress = ((currentQuestion) / QUESTIONS.length) * 100;
      document.getElementById('progressFill').style.width = progress + '%';
      document.getElementById('progressFill').textContent = Math.round(progress) + '%';
      document.getElementById('questionProgress').textContent = currentQuestion;
    }
    
    async function startAnswer() {
      if (isRecording) return;
      
      isRecording = true;
      document.getElementById('startBtn').classList.add('hidden');
      document.getElementById('submitBtn').classList.remove('hidden');
      
      try {
        recordedChunks = [];
        
        try {
          mediaRecorder = new MediaRecorder(webcamStream, { mimeType: 'video/webm;codecs=vp8,opus' });
        } catch (e) {
          console.warn("Specific mimeType failed, falling back to browser default");
          mediaRecorder = new MediaRecorder(webcamStream);
        }

        mediaRecorder.ondataavailable = function(event) {
          if (event.data.size > 0) {
            recordedChunks.push(event.data);
          }
        };
        
        mediaRecorder.start();
        
        recordingStartTime = Date.now();
        const duration = QUESTIONS[currentQuestion].duration;
        let remaining = duration;
        document.getElementById('timer').textContent = remaining;
        
        timerInterval = setInterval(function() {
          remaining--;
          document.getElementById('timer').textContent = remaining;
          if (remaining <= 0) submitAnswer();
        }, 1000);
        
      } catch (err) {
        console.error('Recording error:', err);
        alert('‚ùå Recording failed. Please refresh the page and try again.');
        isRecording = false;
        document.getElementById('startBtn').classList.remove('hidden');
        document.getElementById('submitBtn').classList.add('hidden');
      }
    }

    async function submitAnswer() {
      if (!isRecording) return;
      
      isRecording = false;
      clearInterval(timerInterval);
      
      document.getElementById('submitBtn').classList.add('hidden');
      document.getElementById('startBtn').classList.remove('hidden');
      document.getElementById('startBtn').textContent = '‚è≥ Processing...';
      document.getElementById('startBtn').disabled = true;
      
      try {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
          mediaRecorder.stop();
        }
        
        await new Promise(resolve => setTimeout(resolve, 500));
        
        const blob = new Blob(recordedChunks, { type: 'video/webm' });
        
        const reader = new FileReader();
        reader.readAsDataURL(blob);
        
        reader.onloadend = async function() {
          const base64data = reader.result;
          
          try {
            const duration = (Date.now() - recordingStartTime) / 1000;
            
            const response = await fetch('/submit_answer', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                question_id: QUESTIONS[currentQuestion].id,
                question_text: QUESTIONS[currentQuestion].question,
                audio: base64data,
                video: base64data,
                transcript: '',
                duration: duration
              })
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
              if (result.session_status === 'completed') {
                completeInterview();
              } else {
                loadQuestion(result.next_question);
                document.getElementById('startBtn').textContent = 'üé§ Start Recording';
                document.getElementById('startBtn').disabled = false;
              }
            }
          } catch (err) {
            console.error('Submit fetch error:', err);
            alert('‚ùå Failed to upload answer. See console for details.');
            document.getElementById('startBtn').textContent = 'üé§ Start Recording';
            document.getElementById('startBtn').disabled = false;
          }
        };
      } catch (err) {
        console.error('Submit processing error:', err);
        alert('‚ùå Error processing recording.');
        document.getElementById('startBtn').textContent = 'üé§ Start Recording';
        document.getElementById('startBtn').disabled = false;
      }
    }
    
    function completeInterview() {
      sessionData.status = 'completed';
      
      document.getElementById('questionArea').classList.add('hidden');
      document.getElementById('completionArea').classList.remove('hidden');
      
      updateProgress();
    }
    
    function terminateInterview(reason) {
      sessionData.status = 'terminated';
      clearInterval(timerInterval);
      
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
      }
      
      document.getElementById('questionArea').classList.add('hidden');
      document.getElementById('terminationArea').classList.remove('hidden');
      document.getElementById('terminationReason').textContent = reason;
    }
    
    function viewResults() {
      window.location.href = '/results';
    }
    
    window.onload = init;
    
    window.onbeforeunload = function() {
      if (webcamStream) {
        webcamStream.getTracks().forEach(track => track.stop());
      }
    };
  </script>
</body>
</html>
